---
AWSTemplateFormatVersion: 2010-09-09
Description: >-
 bastion via cloudformation
Parameters:
    
  KeyName:
    Description: Name of an existing EC2 KeyPair to enable SSH access to the instance
    Type: 'AWS::EC2::KeyPair::KeyName'
    Default: ''
    ConstraintDescription: must be the name of an existing EC2 KeyPair.
  AmiID:
    Type: 'AWS::SSM::Parameter::Value<AWS::EC2::Image::Id>'
    Default: '/aws/service/ami-amazon-linux-latest/amzn2-ami-hvm-x86_64-gp2'
  InstanceType:
    Description: WebServer EC2 instance type
    Type: String
    Default: t2.small
    MinLength: '1'
    MaxLength: '41'
    ConstraintDescription: must be a valid EC2 instance type.
 # SourceSSHSecurityGroupName:
   # Description: 'The security group name that is allowed to SSH to this instance'
   # Type: 'AWS::EC2::SecurityGroup::GroupName'
   # ConstraintDescription: must be to bastion host only
  SourceSSHCidr:
    Description: ' The IP address range that can be used to SSH to the EC2 instances'
    Type: String
    MinLength: '9'
    MaxLength: '18'
    Default: 0.0.0.0/0
    AllowedPattern: '(\d{1,3})\.(\d{1,3})\.(\d{1,3})\.(\d{1,3})/(\d{1,2})'
    ConstraintDescription: must be a valid IP CIDR range of the form x.x.x.x/x.
Resources:
  BastionHost:
    Type: 'AWS::EC2::Instance'
    Properties:
      KeyName: !Ref KeyName
      ImageId: !Ref AmiID 
      SecurityGroups:
        - !Ref SshToBastionSecgrp
      Tags:
      -
        Key: Name
        Value: 'bastionhost-cf'  
  SshToBastionSecgrp:
    Type: 'AWS::EC2::SecurityGroup'
    Properties:
      GroupDescription: Enable ssh access via port 22
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: '22'
          ToPort: '22'
          CidrIp: 0.0.0.0/0
          #SourceSecurityGroupName: !Ref SourceSSHSecurityGroupName
Outputs:
  WebsiteURL:
    Description: URL for newly created bastion host
    Value: !Join 
      - ''
      - - 'http://'
        - !GetAtt 
          - BastionHost
          - PublicDnsName
          - PublicIp
          
